<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AUREA AI â€” Strategy Code Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <!-- Load CodeMirror 6 from CDN for client-side code editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.0.1/codemirror.min.css" />
  <style>
    .container{ max-width:1100px; margin:20px auto; color:#e6f7ff; }
    textarea#code { width:100%; height:420px; background:#0b1220; color:#dff; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.05); font-family:monospace; font-size:13px; }
    .controls { display:flex; gap:8px; margin-bottom:8px; }
    button.primary { background:#2dd4ff; color:#001; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .meta { margin-bottom:8px; color:#9fdcff; font-size:13px; }
  </style>
</head>
<body class="dark">
  <div class="container">
    <h1>Strategy Code Editor</h1>
    <div class="meta">Write a strategy in the small Python DSL (safe subset). The backend validates before saving.</div>
    <div class="controls">
      <input id="name" placeholder="Strategy name" />
      <input id="owner" placeholder="Owner wallet address" />
      <button class="primary" onclick="saveCode()">Save (validate & save)</button>
      <button onclick="runBacktest()">Backtest</button>
      <button onclick="exportCode()">Export</button>
    </div>

    <textarea id="code" spellcheck="false">
# Example strategy (safe subset)
def strategy(context):
    # context: {'price': latest_price, 'indicators': {'rsi': 28, 'bb_low': xxx}, 'wallet': {...}}
    if context['indicators']['rsi'] < 30:
        return {'action':'buy', 'amount_pct':10}
    if context['indicators']['rsi'] > 70:
        return {'action':'sell', 'amount_pct':100}
    return {'action':'hold'}
    </textarea>

    <div style="margin-top:12px;">
      <h3>Validation messages</h3>
      <pre id="messages" style="background:rgba(0,0,0,0.5); padding:12px; border-radius:6px; min-height:80px;"></pre>
    </div>
  </div>

  <script>
    async function saveCode(){
      const name = document.getElementById('name').value || 'code-strategy';
      const owner = document.getElementById('owner').value || '';
      const source = document.getElementById('code').value;
      // simple client-side checks
      const blocked = ['import','subprocess','eval(','exec(','__import__','open('];
      for(const b of blocked) if(source.indexOf(b)!==-1){
        document.getElementById('messages').textContent = 'Validation failed: forbidden expression: '+b;
        return;
      }
      // POST to /api/strategies with mode 'code'
      const payload = { name, owner, mode:'code', spec:{ lang:'python', source }, symbols:[], timeframe:'1h', enabled:false };
      const resp = await fetch('/api/strategies/', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      const j = await resp.json();
      document.getElementById('messages').textContent = 'Saved: ' + JSON.stringify(j, null, 2);
    }

    async function runBacktest(){
      const source = document.getElementById('code').value;
      // simple call to backend backtest endpoint; for MVP we just show placeholder
      document.getElementById('messages').textContent = 'Backtest started (placeholder).';
    }

    function exportCode(){
      const src = document.getElementById('code').value;
      const blob = new Blob([src], { type:'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (document.getElementById('name').value || 'strategy')+'.py'; a.click();
    }
  </script>
</body>
</html>
